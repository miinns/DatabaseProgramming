
ALTER session set "_ORACLE_SCRIPT"=true;
DROP USER fruit CASCADE; -- 기존 사용자 삭제(현재 접속되어 있으면 삭제 안 됨)
	-- CASCADE option : 관련 스키마 개체들도 함께 삭제.  Default는 No Action
CREATE USER fruit IDENTIFIED BY 1234  -- 사용자 ID : fruit, 비밀번호 : 1234
    DEFAULT TABLESPACE USERS
    TEMPORARY TABLESPACE TEMP;
GRANT connect, resource, dba TO fruit; -- 권한 부여

--------------------------------------------------------
--  DDL for Table 과일
--------------------------------------------------------

  CREATE TABLE "과일" 
   (	"과일아이디" NUMBER(38,0), 
	"과일이름" VARCHAR2(26 BYTE), 
	"수량" NUMBER(38,0), 
	"가격" NUMBER(38,0), 
	"보존기간" VARCHAR2(26 BYTE), 
	"업체번호" NUMBER(38,0), 
	"예약번호" NUMBER(38,0)
   ) ;
--------------------------------------------------------
--  DDL for Table 납품업체
--------------------------------------------------------

  CREATE TABLE "납품업체" 
   (	"업체번호" NUMBER(38,0), 
	"납품업체명" VARCHAR2(26 BYTE), 
	"전화번호" VARCHAR2(26 BYTE), 
	"위치" VARCHAR2(128 BYTE)
   ) ;
--------------------------------------------------------
--  DDL for Table 손님
--------------------------------------------------------

  CREATE TABLE "손님" 
   (	"이름" VARCHAR2(26 BYTE), 
	"주소" VARCHAR2(128 BYTE), 
	"전화번호" VARCHAR2(26 BYTE), 
	"계좌번호" VARCHAR2(26 BYTE), 
	"손님번호" NUMBER(38,0),
        "적립금" NUMBER(38,0)
   ) ;
--------------------------------------------------------
--  DDL for Table 손상과일
--------------------------------------------------------

  CREATE TABLE "손상과일" 
   (	"과일아이디" NUMBER(38,0), 
	"손상과일번호" NUMBER(38,0), 
	"파손" VARCHAR2(26 BYTE), 
	"상함" VARCHAR2(26 BYTE), 
	"보존기간만료" VARCHAR2(26 BYTE)
   ) ;
--------------------------------------------------------
--  DDL for Table 예약
--------------------------------------------------------

  CREATE TABLE "예약" 
   (	"예약번호" NUMBER(38,0), 
	"손님번호" NUMBER(38,0), 
	"주문과일종류" VARCHAR2(26 BYTE), 
	"주문수량" NUMBER(38,0),
	"주문날짜" VARCHAR2(26 BYTE)
   ) ;

REM INSERTING into "과일"
SET DEFINE OFF;
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (1,'석류',12,4000,'2023.12.19',1,6);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (2,'감',20,800,'2023.12.14',2,7);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (3,'포도 ',20,3200,'2023.10.13',1,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (5,'레몬',7,2500,'2023.09.10',1,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (6,'사과',15,1100,'2023.10.17',4,1);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (7,'파인애플',5,7000,'2023.11.19',6,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (8,'복숭아',8,3000,'2023.11.08',7,9);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (9,'코코넛',3,4000,'2023.12.24',8,8);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (11,'자몽',24,3000,'2023.12.12',5,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (12,'수박',12,12000,'2023.10.19',1,4);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (13,'멜론',5,15000,'2023.12.25',2,3);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (15,'블루베리',24,6000,'2023.09.27',4,2);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (17,'무화과',6,3500,'2023.09.12',6,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (19,'한라봉',14,3500,'2023.11.30',4,5);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (20,'귤',23,500,'2023.10.13',1,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (21,'키위',14,3000,'2023.11.12',2,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (22,'바나나',16,7700,'2023.10.01',6,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (23,'체리',26,8000,'2023.10.28',5,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (24,'청포도',18,6000,'2023.11.23',4,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (25,'거봉',23,7000,'2023.11.11',5,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (26,'산딸기',12,6500,'2023.09.19',6,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (27,'샤인머스켓',32,10000,'2023.11.19',5,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (28,'용과',13,9500,'2023.12.19',4,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (29,'망고',24,3000,'2023.10.19',1,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (30,'참외',11,3500,'2023.09.19',1,null);
Insert into "과일" ("과일아이디","과일이름","수량","가격","보존기간","업체번호","예약번호") values (31,'오렌지',9,2500,'2023.10.19',4,10);

REM INSERTING into "납품업체"
SET DEFINE OFF;
Insert into "납품업체" ("업체번호","납품업체명","전화번호","위치") values (1,'나눔유통','031-542-8455','경기도 고양시 일산동구 백석동 1257-9');
Insert into "납품업체" ("업체번호","납품업체명","전화번호","위치") values (2,'가락시장','02-551-1565','서울 특별시 송파구 가락동 600');
Insert into "납품업체" ("업체번호","납품업체명","전화번호","위치") values (3,'우정에스케이와이','02-569-1549','서울 특별시 송파구 가락동 600');
Insert into "납품업체" ("업체번호","납품업체명","전화번호","위치") values (4,'제이원프레쉬','051-658-1655','부산광역시 사상구 엄궁동 651-33');
Insert into "납품업체" ("업체번호","납품업체명","전화번호","위치") values (5,'동원홈푸드','042-822-8153','대전광역시 유성구 노은동 566');
Insert into "납품업체" ("업체번호","납품업체명","전화번호","위치") values (6,'왕식자제마트','041-662-7200','충청남도 서산시 잠홍동 611');
Insert into "납품업체" ("업체번호","납품업체명","전화번호","위치") values (7,'동아유통','032-422-0434','인천광역시 남동구 구월동 1175-18');
Insert into "납품업체" ("업체번호","납품업체명","전화번호","위치") values (8,'필스푸드','032-425-4553','인천광역시 서구 대곡동 646-6');

REM INSERTING into "손님"
SET DEFINE OFF;
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('박원자','경기도 화성시 마도면 마도로 794','010-1234-5678','111-11-111111',1,55);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('김이나','강원도 양구군 남면 정중앙로 611-1','010-1125-4565','111-11-111112',2,120);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('서상희','강원도 원주시 천매봉길 40-7(단구동)','010-5155-8165','111-11-111113',3,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('정경일','경상남도 통영시 주전1길 12(태평동)','010-7255-4826','111-11-111114',4,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('안태우','경상남도 하동군 적량면 계성길 29-16','010-2456-1254','111-11-111115',5,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('탁윤영','경상북도 영양군 석보면 원요로 399','010-2515-5489','111-11-111116',6,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('예홍주','경기도 성남시 중원구 금상로 63(금광동)','010-2154-8795','111-11-111117',7,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('표종하','경상북도 포항시 남구 대이로46번길 25(대잠동)','010-5785-4569','111-11-111118',8,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('정준하','경상북도 경산시 와촌면 시천1길 21-5','010-5487-2546','111-11-111119',9,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('백은혜','서울특별시 노원구 한글비석로37길 12(상계동)','010-2154-6895','111-11-111110',10,100);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('추영한','전라북도 전주시 덕진구 행치길 26-10(산정동)','010-5698-4568','111-11-111211',11,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('이은지','경기도 연천군 미산면 유노로 109','010-4699-7566','111-11-111212',12,40);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('최진성','경기도 용인시 처인구 양지면 평창로102번길 47','010-1547-8563','111-11-111213',13,240);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('안현준','경기도 화성시 남양읍 현대기아로324번길 31-5','010-5485-1236','111-11-111214',14,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('송우민','경기도 화성시 정남면 만년로 232-24','010-2458-4752','111-11-111215',15,80);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('봉종식','경상북도 칠곡군 북삼읍 숭산로 55','010-2369-5485','111-11-111216',16,150);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('백재현','전라남도 여수시 주삼덕양로 78(화장동)','010-5471-2156','111-11-111217',17,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('성시호','대구광역시 수성구 수성로51길 35(중동)','010-2364-4562','111-11-111218',18,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('한기영','경상남도 하동군 악양면 노전길 119-23','010-2545-6965','111-11-111219',19,null);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('이우진','부산광역시 부산진구 대학로 12번길 21','010-3321-7918','111-11-111220',20,280);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('박지현','부산광역시 부산진구 대학로 13번길 11','010-1211-1215','111-11-111221',21,80);
Insert into "손님" ("이름","주소","전화번호","계좌번호","손님번호","적립금") values ('김정수','부산광역시 부산진구 대학로 38번길 39','010-5697-1547','111-11-111222',22,360);

REM INSERTING into "손상과일"
SET DEFINE OFF;
Insert into "손상과일" ("과일아이디","손상과일번호","파손","상함","보존기간만료") values (32,1,'FALSE','FALSE','TRUE');
Insert into "손상과일" ("과일아이디","손상과일번호","파손","상함","보존기간만료") values (33,2,'FALSE','FALSE','TRUE');
Insert into "손상과일" ("과일아이디","손상과일번호","파손","상함","보존기간만료") values (34,3,'FALSE','TRUE','FALSE');
Insert into "손상과일" ("과일아이디","손상과일번호","파손","상함","보존기간만료") values (35,4,'FALSE','FALSE','TRUE');
Insert into "손상과일" ("과일아이디","손상과일번호","파손","상함","보존기간만료") values (4,5,'FALSE','TRUE','FALSE');
Insert into "손상과일" ("과일아이디","손상과일번호","파손","상함","보존기간만료") values (10,6,'FALSE','TRUE','FALSE');
Insert into "손상과일" ("과일아이디","손상과일번호","파손","상함","보존기간만료") values (14,7,'TRUE','FALSE','FALSE');
Insert into "손상과일" ("과일아이디","손상과일번호","파손","상함","보존기간만료") values (16,8,'TRUE','FALSE','FALSE');
Insert into "손상과일" ("과일아이디","손상과일번호","파손","상함","보존기간만료") values (18,9,'FALSE','TRUE','FALSE');

REM INSERTING into "예약"
SET DEFINE OFF;
Insert into "예약" ("예약번호","손님번호","주문과일종류","주문수량","주문날짜") values (1,1,'사과',5,'2023.10.01');
Insert into "예약" ("예약번호","손님번호","주문과일종류","주문수량","주문날짜") values (2,2,'블루베리',2,'2023.09.11');
Insert into "예약" ("예약번호","손님번호","주문과일종류","주문수량","주문날짜") values (3,16,'멜론',1,'2023.12.20');
Insert into "예약" ("예약번호","손님번호","주문과일종류","주문수량","주문날짜") values (4,13,'수박',2,'2023.10.06');
Insert into "예약" ("예약번호","손님번호","주문과일종류","주문수량","주문날짜") values (5,20,'한라봉',8,'2023.11.25');
Insert into "예약" ("예약번호","손님번호","주문과일종류","주문수량","주문날짜") values (6,12,'석류',1,'2023.12.01');
Insert into "예약" ("예약번호","손님번호","주문과일종류","주문수량","주문날짜") values (7,15,'감',10,'2023.12.01');
Insert into "예약" ("예약번호","손님번호","주문과일종류","주문수량","주문날짜") values (8,21,'코코넛',2,'2023.12.19');
Insert into "예약" ("예약번호","손님번호","주문과일종류","주문수량","주문날짜") values (9,22,'복숭아',12,'2023.11.01');
Insert into "예약" ("예약번호","손님번호","주문과일종류","주문수량","주문날짜") values (10,10,'오렌지',4,'2023.10.12');

-- <프로시저>
SET SERVEROUTPUT ON;
CREATE OR REPLACE PROCEDURE SP_주문통계 (
P_시작날짜 IN DATE,
P_종료날짜 IN DATE,
P_판매량 OUT NUMBER,
P_매출 OUT NUMBER)
AS
BEGIN
SELECT SUM(주문수량), SUM(주문수량 * 가격) INTO P_판매량, P_매출
FROM 예약
JOIN 과일 ON 예약.예약번호 = 과일.예약번호
WHERE 주문날짜 BETWEEN P_시작날짜 AND P_종료날짜;
END;

create or replace NONEDITIONABLE PROCEDURE SP_주문처리 (
  P_예약번호 IN VARCHAR2,
  P_손님번호 IN VARCHAR2,
  P_주문과일종류 IN VARCHAR2,
  P_주문수량 IN NUMBER,
  P_주문날짜 IN DATE,
  P_RESULT OUT VARCHAR2
) AS
  V_수량 NUMBER;
BEGIN
  -- 과일 수량 조회
  SELECT 수량 INTO V_수량 FROM 과일 WHERE 과일이름 = P_주문과일종류 FOR UPDATE;

  -- 주문 처리
  IF V_수량 >= P_주문수량 THEN
    -- 주문 성공 시 재고 감소
    UPDATE 과일 SET 수량 = V_수량 - P_주문수량 WHERE 과일이름 = P_주문과일종류;
    
    -- 예약 테이블에 저장
    INSERT INTO 예약 (예약번호, 손님번호, 주문과일종류, 주문수량, 주문날짜)
    VALUES (P_예약번호, P_손님번호, P_주문과일종류, P_주문수량, P_주문날짜);

    -- 재고가 3개 이하일 경우 알림
    IF V_수량 - P_주문수량 <= 3 THEN
      P_RESULT := '주문이 성공적으로 처리되었습니다. 현재 재고가 3개 이하입니다.';
    ELSE
      P_RESULT := '주문이 성공적으로 처리되었습니다.';
    END IF;
  ELSE
    -- 주문 실패 시
    P_RESULT := '주문을 처리할 수 없습니다. 현재 매장에 있는 재고는 ' || V_수량 || '개 입니다.';
  END IF;
END;

-- <트리거>
SET SERVEROUTPUT ON;
CREATE OR REPLACE TRIGGER T_납품업체알림
AFTER INSERT
ON 손상과일
FOR EACH ROW
DECLARE
V_업체번호 NUMBER;
V_납품업체알림 VARCHAR2(100);
BEGIN
SELECT 업체번호 INTO V_업체번호 FROM 과일 WHERE 과일아이디 = :NEW.과일아이디;
V_납품업체알림 := '<손상 과일 추가> 업체번호 : ' || V_업체번호 || ', 손상과일아이디 : ' || :NEW.과일아이디;
 DBMS_OUTPUT.PUT_LINE(V_납품업체알림);
DELETE FROM 과일 WHERE 과일아이디 = :NEW.과일아이디;
END;

create or replace NONEDITIONABLE TRIGGER T_적립금
AFTER INSERT
ON 예약
FOR EACH ROW
DECLARE
V_가격 NUMBER;
V_적립금 NUMBER;
BEGIN
UPDATE 과일 SET 예약번호 = :NEW.예약번호 WHERE 과일이름 = :NEW.주문과일종류;
SELECT 가격 INTO V_가격 FROM 과일 WHERE 과일이름 = :NEW.주문과일종류;
V_적립금 := :NEW.주문수량 * V_가격 * 0.01;
UPDATE 손님 SET 적립금 = NVL(적립금, 0) + V_적립금 WHERE 손님번호 =: NEW.손님번호;
END;

CREATE OR REPLACE NONEDITIONABLE TRIGGER T_예약취소
BEFORE DELETE
ON 예약
FOR EACH ROW
DECLARE
    V_가격 NUMBER;
    V_적립금 NUMBER;
BEGIN
    UPDATE 과일 SET 예약번호 = NULL, 수량 = 수량 + :OLD.주문수량 WHERE 과일이름 = :OLD.주문과일종류;
    SELECT 가격 INTO V_가격 FROM 과일 WHERE 과일이름 = :OLD.주문과일종류;
    V_적립금 := :OLD.주문수량 * V_가격 * 0.01;
    UPDATE 손님 SET 적립금 = NVL(적립금, 0) - V_적립금 WHERE 손님번호 = :OLD.손님번호;
END;

COMMIT;
